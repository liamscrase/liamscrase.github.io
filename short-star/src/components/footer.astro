---
const year = new Date().getFullYear();
---

<footer id="site-footer">
  <div class="footer-inner">
    <h2 class="fade-up">ᯓ➤ <br> Get in touch</h2>
    <form id="contact-form" class="contact-form fade-up" novalidate>
      <label>
        Name
        <input type="text" name="name" required />
      </label>

      <label>
        Email
        <input type="email" name="email" required />
      </label>

      <label>
        Message
        <textarea name="message" rows="6" required></textarea>
      </label>

      <input
        type="hidden"
        name="_subject"
        value="New contact form submission"
      />

      <button type="submit" class="button primary">Send</button>
    </form>
    <div id="contact-result" aria-live="polite"></div>
  </div>
</footer>

<script>
  (function () {
    const form = document.getElementById(
      "contact-form",
    ) as HTMLFormElement | null;
    const result = document.getElementById(
      "contact-result",
    ) as HTMLElement | null;
    if (!form || !result) return;

    const nameInput = form.querySelector('[name="name"]') as HTMLInputElement;
    const emailInput = form.querySelector('[name="email"]') as HTMLInputElement;
    const messageInput = form.querySelector('[name="message"]') as HTMLTextAreaElement;

    function showResult(
      el: HTMLElement,
      message: string,
      status: "success" | "error",
      details?: { name?: string; email?: string; message?: string },
    ) {
      // Clear existing content
      el.innerHTML = "";
      el.className = "";

      // Title
      const title = document.createElement("div");
      title.textContent = message;
      el.appendChild(title);

      // Optional details (safe text-only rendering)
      if (details) {
        const container = document.createElement("div");
        container.className = "result-details";

        if (details.name) {
          const p = document.createElement("p");
          const strong = document.createElement("strong");
          strong.textContent = "Name: ";
          p.appendChild(strong);
          p.appendChild(document.createTextNode(details.name));
          container.appendChild(p);
        }

        if (details.email) {
          const p = document.createElement("p");
          const strong = document.createElement("strong");
          strong.textContent = "Email: ";
          p.appendChild(strong);
          p.appendChild(document.createTextNode(details.email));
          container.appendChild(p);
        }

        if (details.message) {
          const p = document.createElement("p");
          const strong = document.createElement("strong");
          strong.textContent = "Message: ";
          p.appendChild(strong);
          const msgSpan = document.createElement("span");
          msgSpan.textContent = details.message;
          msgSpan.style.whiteSpace = "pre-wrap";
          p.appendChild(msgSpan);
          container.appendChild(p);
        }

        el.appendChild(container);
      }

      // force reflow so transitions apply when toggling
      void el.offsetWidth;
      el.classList.add("show");
      if (status === "success") el.classList.add("success");
      if (status === "error") el.classList.add("error");
    }

    function clearFieldError(input: HTMLInputElement | HTMLTextAreaElement) {
      input.classList.remove("invalid");
      const existingError = input.parentElement?.querySelector(".field-error");
      if (existingError) existingError.remove();
    }

    function showFieldError(
      input: HTMLInputElement | HTMLTextAreaElement,
      message: string,
    ) {
      clearFieldError(input);
      input.classList.add("invalid");
      const errorSpan = document.createElement("span");
      errorSpan.className = "field-error";
      errorSpan.textContent = message;
      input.parentElement?.appendChild(errorSpan);
    }

    function validateField(input: HTMLInputElement | HTMLTextAreaElement): boolean {
      const value = input.value.trim();

      if (!value) {
        showFieldError(input, `Please enter your ${input.name}`);
        return false;
      }

      if (input.type === "email") {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(value)) {
          showFieldError(input, "Please enter a valid email address");
          return false;
        }
      }

      clearFieldError(input);
      return true;
    }

    // Add blur validation for real-time feedback
    [nameInput, emailInput, messageInput].forEach((input) => {
      input.addEventListener("blur", () => validateField(input));
      input.addEventListener("input", () => {
        if (input.classList.contains("invalid")) {
          validateField(input);
        }
      });
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      // Validate all fields
      const nameValid = validateField(nameInput);
      const emailValid = validateField(emailInput);
      const messageValid = validateField(messageInput);

      if (!nameValid || !emailValid || !messageValid) {
        const errors: string[] = [];
        if (!nameValid) errors.push("name");
        if (!emailValid) errors.push("email");
        if (!messageValid) errors.push("message");

        showResult(
          result,
          `Please fill in all required fields: ${errors.join(", ")}`,
          "error",
        );
        return;
      }

      const data = new FormData(form);
      try {
        const res = await fetch("https://formspree.io/f/xgoloyrj", {
          method: "POST",
          body: data,
          headers: { Accept: "application/json" },
        });
        if (res.ok) {
          // capture submitted values before resetting the form
          const submitted = {
            name: nameInput.value,
            email: emailInput.value,
            message: messageInput.value,
          };
          showResult(
            result,
            "Thanks — message sent. We will get back to you soon.",
            "success",
            submitted,
          );
          form.classList.add("contact-sent");
          form.reset();
          // Clear any validation states
          [nameInput, emailInput, messageInput].forEach(clearFieldError);
        } else {
          showResult(result, "Send failed. Please try again.", "error");
        }
      } catch (err) {
        showResult(result, "Network error. Try again later.", "error");
      }
    });
  })();
</script>